name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "SemVer without leading v (e.g. 0.1.0)"
        required: true

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build release assets (zip + module.json)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $version = "${{ inputs.version }}".Trim()
          if ($version -notmatch '^\d+\.\d+\.\d+([\-+].+)?$') {
            throw "Invalid version '$version'. Expected SemVer like 0.1.0"
          }

          $repo = "${{ github.repository }}"
          $moduleId = "allow-player-create-tile"
          $asset = "$moduleId-v$version.zip"

          $distRoot = Join-Path $PWD "dist"
          if (Test-Path $distRoot) { Remove-Item $distRoot -Recurse -Force }
          New-Item -ItemType Directory -Path $distRoot | Out-Null

          # Build a release-specific manifest as a Release asset (do not commit to main).
          $sourceManifestPath = Join-Path $PWD "module.json"
          $manifest = Get-Content $sourceManifestPath -Raw | ConvertFrom-Json
          $manifest.version = $version
          $manifest.url = "https://github.com/$repo"
          $manifest.manifest = "https://github.com/$repo/releases/latest/download/module.json"
          $manifest.download = "https://github.com/$repo/releases/download/v$version/$asset"

          ($manifest | ConvertTo-Json -Depth 100) + "`n" | Set-Content -NoNewline -Encoding UTF8 (Join-Path $distRoot "module.json")

          # Stage module folder and zip it with the correct root folder name.
          $stage = Join-Path $distRoot $moduleId
          New-Item -ItemType Directory -Path $stage | Out-Null

          Copy-Item -Force (Join-Path $distRoot "module.json") (Join-Path $stage "module.json")
          if (Test-Path (Join-Path $PWD "README.md")) { Copy-Item -Force (Join-Path $PWD "README.md") $stage }
          if (Test-Path (Join-Path $PWD "LICENSE")) { Copy-Item -Force (Join-Path $PWD "LICENSE") $stage }
          Copy-Item -Recurse -Force (Join-Path $PWD "scripts") $stage
          Copy-Item -Recurse -Force (Join-Path $PWD "lang") $stage

          Compress-Archive -Path $stage -DestinationPath (Join-Path $distRoot $asset) -Force

      - name: Tag release
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "Tag v${VERSION} already exists. Refusing to overwrite."
            exit 1
          fi
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          generate_release_notes: true
          files: |
            dist/*.zip
            dist/module.json
